#!/usr/bin/env bash

set -euo pipefail

# @@ collect data

hostname=$(dialog --stdout --inputbox "Enter hostname" 0 0) || exit 1
clear
: "${hostname:?"hostname cannot be empty"}"

username=$(dialog --stdout --inputbox "Enter username" 0 0) || exit 1
clear
: "${user:?"username cannot be empty"}"

password=$(dialog --stdout --passwordbox "Enter user password" 0 0) || exit 1
clear
: "${password:?"password cannot be empty"}"
password2=$(dialog --stdout --passwordbox "Enter user password again" 0 0) || exit 1
clear
[[ "$password" == "$password2" ]] || ( echo "Passwords did not match"; exit 1; )

password_root=$(dialog --stdout --passwordbox "Enter root password" 0 0) || exit 1
clear
: "${password_root:?"password cannot be empty"}"
password_root2=$(dialog --stdout --passwordbox "Enter root password again" 0 0) || exit 1
clear
[[ "$password_root" == "$password_root2" ]] || ( echo "Passwords did not match"; exit 1; )

# @@ set console font

cat > /etc/vconsole.conf << EOF
FONT=${CONSOLE_FONT}
EOF

# @@ set hostname

echo "${hostname}" > /etc/hostname

cat > /etc/hosts << EOF
127.0.0.1 localhost
::1       localhost
127.0.1.1 ${hostname}.localdomain ${hostname}
EOF

# @@ mkinitcpio

sed -i 's/^\(HOOKS=\).*$/\1(base udev autodetect keyboard consolefont modconf block encrypt lvm filesystems fsck)/' /etc/mkinitcpio.conf

mkinitcpio -p linux
mkinitcpio -p linux-lts

# @@ locale

sed -i 's/\#en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen

locale-gen

ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime

hwclock --systohc

# @@ setup users and groups

useradd "$username" -s /usr/bin/zsh -mUG wheel docker


echo "root:${password_root}" | chpasswd
echo "${username}:${password}" | chpasswd

# @@ setup bootloader

bootctl --path=/boot install

cat <<EOF > /mnt/boot/loader/loader.conf
default arch
timeout 3
EOF

cat <<EOF > /mnt/boot/loader/entries/arch.conf
title    Arch Linux
linux    /vmlinuz-linux
initrd   /initramfs-linux.img
options  cryptdevice=UUID=$(blkid -s PARTUUID -o value "$PART_LUKS_LVM"):${VG} root=/dev/mapper/${LV_ROOT} rw
EOF
