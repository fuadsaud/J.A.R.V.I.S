#!/usr/bin/env bash

set -euo pipefail

if $(lsblk | grep nvme0n1); then
  export DISK="/dev/nvme0n1"
  export DISK_PARTITION_SUFFIX="p"
else
  export DISK="/dev/sda"
  export DISK_PARTITION_SUFFIX=""
fi

echo "Disk: ${DISK}"

export PART_EFI="${DISK}${DISK_PARTITION_SUFFIX}1"
export PART_BOOT="${DISK}${DISK_PARTITION_SUFFIX}2"
export PART_LUKS_LVM="${DISK}${DISK_PARTITION_SUFFIX}3"

export VG="vg0"
export LV_ROOT="lv_root"
export LV_VAR="lv_var"
export LV_HOME="lv_home"

export LV_ROOT_SIZE="10GB"
export LV_VAR_SIZE="10GB"
export LV_HOME_SIZE="100%FREE"

echo "/ size: $LV_ROOT_SIZE"
echo "/var size: $LV_VAR_SIZE"
echo "/home size: $LV_HOME_SIZE"

export PART_ROOT="/dev/${VG}/${LV_ROOT}"
export PART_VAR="/dev/${VG}/${LV_VAR}"
export PART_HOME="/dev/${VG}/${LV_HOME}"

# @@ mkinitcpio

# TODO: edit /etc/mkinicpio.conf

mkinitcpio -p linux
mkinitcpio -p linux-lts

# @@ locale

# TODO: edit /etc/locale.gen

locale-gen

# @@ setup users and groups

passwd

useradd fuad -G wheel

# @@ setup bootloader

# TODO: edit /etc/default/grub

mkdir /boot/EFI

mount "$part_efi" /boot/EFI

grub-install --target=x86_64-efi --bootloader-id=grub_uefi --recheck

cp /usr/share/locale/en\@quot/LC_MESSAGES/grub.mo /boot/grub/locale/en.mo

grub-mkconfig -o /boot/gru/grub.cfg
