#!/usr/bin/env bash

set -euo pipefail

# @@ collect data

hostname=$(dialog --stdout --inputbox "Enter hostname" 0 0) || exit 1
clear
: ${hostname:?"hostname cannot be empty"}

user=$(dialog --stdout --inputbox "Enter admin username" 0 0) || exit 1
clear
: ${user:?"user cannot be empty"}

password=$(dialog --stdout --passwordbox "Enter user password" 0 0) || exit 1
clear
: ${password:?"password cannot be empty"}
password2=$(dialog --stdout --passwordbox "Enter user password again" 0 0) || exit 1
clear
[[ "$password" == "$password2" ]] || ( echo "Passwords did not match"; exit 1; )

password_root=$(dialog --stdout --passwordbox "Enter root password" 0 0) || exit 1
clear
: ${password_root:?"password cannot be empty"}
password_root2=$(dialog --stdout --passwordbox "Enter root password again" 0 0) || exit 1
clear
[[ "$password_root" == "$password_root2" ]] || ( echo "Passwords did not match"; exit 1; )

# @@ set console font

cat > /etc/vconsole.conf << EOF
FONT=${CONSOLE_FONT}
EOF

# @@ mkinitcpio

sed -i 's/^\(HOOKS=\).*$/\1(base udev autodetect consolefont modconf block encrypt lvm filesystems keyboard fsck)/' /etc/mkinitcpio.conf

mkinitcpio -p linux
mkinitcpio -p linux-lts

# @@ locale

sed -i 's/\#en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen

locale-gen

ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime

# @@ setup users and groups

passwd

useradd fuad -G wheel

# @@ setup bootloader

sed -i "s/GRUB_CMDLINE_LINUX_DEFAULT=\"\\(.*\\)\"/GRUB_CMDLINE_LINUX_DEFAULT=\"$PART_LUKS_LVM:$VG \\1\"/"

mkdir /boot/EFI

mount "$PART_EFI" /boot/EFI

grub-install --target=x86_64-efi --bootloader-id=grub_uefi --recheck

cp /usr/share/locale/en\@quot/LC_MESSAGES/grub.mo /boot/grub/locale/en.mo

grub-mkconfig -o /boot/gru/grub.cfg
