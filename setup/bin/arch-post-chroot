#!/usr/bin/env bash

set -euo pipefail

if $(lsblk | grep nvme0n1); then
  export DISK="/dev/nvme0n1"
  export DISK_PARTITION_SUFFIX="p"
else
  export DISK="/dev/sda"
  export DISK_PARTITION_SUFFIX=""
fi

echo "Disk: ${DISK}"

export PART_EFI="${DISK}${DISK_PARTITION_SUFFIX}1"
export PART_BOOT="${DISK}${DISK_PARTITION_SUFFIX}2"
export PART_LUKS_LVM="${DISK}${DISK_PARTITION_SUFFIX}3"

export VG="vg0"
export LV_ROOT="lv_root"
export LV_VAR="lv_var"
export LV_HOME="lv_home"

export LV_ROOT_SIZE="10GB"
export LV_VAR_SIZE="10GB"
export LV_HOME_SIZE="100%FREE"

echo "/ size: $LV_ROOT_SIZE"
echo "/var size: $LV_VAR_SIZE"
echo "/home size: $LV_HOME_SIZE"

export PART_ROOT="/dev/${VG}/${LV_ROOT}"
export PART_VAR="/dev/${VG}/${LV_VAR}"
export PART_HOME="/dev/${VG}/${LV_HOME}"

# @@ set console font

cat > /etc/vconsole.conf << EOF
FONT=ter-m32n
EOF

# @@ mkinitcpio

sed -i 's/^\(HOOKS=\).*$/\1(base udev autodetect consolefont modconf block encrypt lvm filesystems keyboard fsck)/' /etc/mkinitcpio.conf

mkinitcpio -p linux
mkinitcpio -p linux-lts

# @@ locale

sed -i 's/\#en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen

locale-gen

ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime

# @@ setup users and groups

passwd

useradd fuad -G wheel

# @@ setup bootloader

sed -i "s/GRUB_CMDLINE_LINUX_DEFAULT=\"\\(.*\\)\"/GRUB_CMDLINE_LINUX_DEFAULT=\"$PART_LUKS_LVM:$VG \\1\"/"

mkdir /boot/EFI

mount "$PART_EFI" /boot/EFI

grub-install --target=x86_64-efi --bootloader-id=grub_uefi --recheck

cp /usr/share/locale/en\@quot/LC_MESSAGES/grub.mo /boot/grub/locale/en.mo

grub-mkconfig -o /boot/gru/grub.cfg
