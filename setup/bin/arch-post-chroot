#!/usr/bin/env bash

set -euo pipefail

# @@ collect data

hostname=$(dialog --stdout --inputbox "Enter hostname" 0 0) || exit 1
clear
: "${hostname:?"hostname cannot be empty"}"

username=$(dialog --stdout --inputbox "Enter username" 0 0) || exit 1
clear
: "${username:?"username cannot be empty"}"

password=$(dialog --stdout --passwordbox "Enter user password" 0 0) || exit 1
clear
: "${password:?"password cannot be empty"}"
password2=$(dialog --stdout --passwordbox "Enter user password again" 0 0) || exit 1
clear
[[ "$password" == "$password2" ]] || ( echo "Passwords did not match"; exit 1; )

password_root=$(dialog --stdout --passwordbox "Enter root password" 0 0) || exit 1
clear
: "${password_root:?"password cannot be empty"}"
password_root2=$(dialog --stdout --passwordbox "Enter root password again" 0 0) || exit 1
clear
[[ "$password_root" == "$password_root2" ]] || ( echo "Passwords did not match"; exit 1; )

# @@ set hostname

echo "${hostname}" > /etc/hostname

cat > /etc/hosts << EOF
127.0.0.1 localhost
::1       localhost
127.0.1.1 ${hostname}.localdomain ${hostname}
EOF

# @@ mkinitcpio

sed -i 's/^\(HOOKS=\).*$/\1(base udev autodetect keyboard consolefont modconf block encrypt lvm2 filesystems fsck)/' /etc/mkinitcpio.conf

mkinitcpio --preset linux
mkinitcpio --preset linux-lts

# @@ locale

sed -i 's/\#en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen

locale-gen

ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime

hwclock --systohc

# @@ setup users and groups

useradd --shell /usr/bin/zsh --create-home --user-group --groups sudo,docker "$username"

visudo /etc/sudoers

echo "root:${password_root}" | chpasswd
echo "${username}:${password}" | chpasswd
