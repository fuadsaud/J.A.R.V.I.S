#!/usr/bin/env bash

set -euo pipefail

# current_dir=$(dirname $(readlink -f ${BASH_SOURCE[0]}))

# export DISK="/dev/sda"

if $(lsblk | grep nvme0n1); then
  export DISK="/dev/nvme0n1"
  export DISK_PARTITION_SUFFIX="p"
else
  export DISK="/dev/sda1"
  export DISK_PARTITION_SUFFIX=""
fi

echo "Disk: ${DISK}"

export PART_EFI="${DISK}${DISK_PARTITION_SUFFIX}1"
export PART_BOOT="${DISK}${DISK_PARTITION_SUFFIX}2"
export PART_LUKS_LVM="${DISK}${DISK_PARTITION_SUFFIX}3"

export VG="vg0"
export LV_ROOT="lv_root"
export LV_VAR="lv_var"
export LV_HOME="lv_home"

export LV_ROOT_SIZE="10GB"
export LV_VAR_SIZE="10GB"
export LV_HOME_SIZE="100%FREE"

echo "/ size: $LV_ROOT_SIZE"
echo "/var size: $LV_VAR_SIZE"
echo "/home size: $LV_HOME_SIZE"

export PART_ROOT="/dev/${VG}/${LV_ROOT}"
export PART_VAR="/dev/${VG}/${LV_VAR}"
export PART_HOME="/dev/${VG}/${LV_HOME}"

# @@ warm up pacman
pacman -Syyy

# TODO: network connection

# @@ set console font

pacman -S --noconfirm terminus-font

setfont /usr/share/kbd/consolefonts/ter-m32n.psf.gz

# @@ update system time/date

timedatectl set-ntp true

# @@ create partitions

sgdisk --zap-all "$DISK"

parted -s "$DISK" -- \
  mklabel gpt \
  mkpart primary 0% 500MiB \
  mkpart primary 500MiB 1GiB \
  mkpart primary 1GiB 100% \
  set 1 esp on

# @@ format partitions

mkfs.fat -F32 "${PART_EFI}"
mkfs.ext4 "${PART_BOOT}"

cryptsetup luksFormat "${PART_LUKS_LVM}"
cryptsetup open --type luks "${PART_LUKS_LVM}" lvm-on-luks

# @@ setup lvm

pvcreate --dataalignment 1m /dev/mapper/lvm-on-luks
vgcreate "$VG" /dev/mapper/lvm-on-luks
lvcreate --size "${LV_ROOT_SIZE}" "$VG" --name "${LV_ROOT}"
lvcreate --size "${LV_VAR_SIZE}"  "$VG" --name "${LV_VAR}"
lvcreate --size "${LV_HOME_SIZE}" "$VG" --name "${LV_HOME}"

modprobe dm_mod
vgscan
vgchange -ay

mkfs.ext4 "${PART_ROOT}"
mkfs.ext4 "${PART_VAR}"
mkfs.ext4 "${PART_HOME}"

# @@ mount partitions

mount "/dev/${VG}/${LV_ROOT}" /mnt

mkdir /mnt/boot
mkdir /mnt/var
mkdir /mnt/home

mount "${PART_BOOT}" /mnt/boot
mount "${PART_VAR}" /mnt/var
mount "${PART_HOME}" /mnt/home

# @@ install arch

pacstrap -i /mnt base

# @@ generate fstab

genfstab -U -p /mnt >> /mnt/etc/fstab

# @@ chroot

# cp "${current_dir}/arch-post-chroot /mnt/root/arch-post-chroot

# arch-chroot /mnt /root/arch-post-chroot

# rm /mnt/root/setup-chroot

# @@ wrap up

umount -R /mnt

echo 'Installation finished.'
